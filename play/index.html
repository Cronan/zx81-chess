<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZX81 1K Chess - Play Online</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background: #1a1a2e;
            color: #eee;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { color: #fff; margin-bottom: 5px; font-size: 24px; }
        .subtitle { color: #888; margin-bottom: 20px; font-size: 14px; }
        .zx81-case {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .screen-bezel {
            background: #111;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        #screen {
            display: block;
            background: #fff;
            image-rendering: pixelated;
            max-width: 100%;
            height: auto;
        }
        .sinclair-logo {
            color: #c00;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            margin-bottom: 15px;
            letter-spacing: 3px;
        }
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover { background: #444; }
        #input-display {
            background: rgba(0,0,0,0.3);
            padding: 8px 15px;
            border-radius: 4px;
            margin-top: 10px;
            text-align: center;
            color: #4fc3f7;
            min-height: 24px;
        }
        .status { color: #4fc3f7; font-size: 12px; margin-top: 10px; text-align: center; }
        .instructions {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-width: 768px;
            line-height: 1.6;
        }
        .instructions h2 { color: #fff; margin-top: 0; font-size: 16px; }
        code { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; color: #4fc3f7; }
        .footer { margin-top: 30px; color: #666; font-size: 12px; }
        .footer a { color: #888; }
        .touch-keyboard {
            display: none;
            margin-top: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
        }
        .key-row {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 5px;
        }
        .key {
            background: #444;
            color: #fff;
            border: 1px solid #666;
            padding: 12px 16px;
            font-family: inherit;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            min-width: 44px;
            text-align: center;
        }
        .key:active { background: #666; }
        .key-enter {
            background: #4fc3f7;
            color: #000;
            padding: 12px 24px;
        }
        .key-enter:active { background: #81d4fa; }
        @media (pointer: coarse) {
            .touch-keyboard { display: block; }
        }
        @media (max-width: 600px) {
            body { padding: 10px; }
            .zx81-case { padding: 15px; max-width: 100%; }
            .screen-bezel { padding: 8px; overflow: hidden; }
            h1 { font-size: 20px; }
            .instructions { padding: 15px; font-size: 14px; }
            .key { padding: 10px 12px; min-width: 36px; font-size: 14px; }
            .key-enter { padding: 10px 20px; }
        }
    </style>
</head>
<body>
    <h1>ZX81 1K Chess</h1>
    <p class="subtitle">672 bytes of Z80 machine code &bull; 1K RAM</p>

    <div class="zx81-case">
        <div class="sinclair-logo">SINCLAIR ZX81</div>
        <div class="screen-bezel">
            <canvas id="screen"></canvas>
        </div>
        <div id="input-display">Press Start Game, then type moves here</div>
        <div class="controls">
            <button id="btn-start">&#9658; Start Game</button>
            <button id="btn-reset">&#8635; Reset</button>
        </div>
        <div class="status" id="status">Click Start Game to play! You are White.</div>
        <div class="status" id="debug" style="font-size: 10px; color: #888; max-height: 100px; overflow-y: auto;"></div>
        <div class="touch-keyboard" id="touch-keyboard">
            <div class="key-row">
                <button class="key" data-key="A">A</button>
                <button class="key" data-key="B">B</button>
                <button class="key" data-key="C">C</button>
                <button class="key" data-key="D">D</button>
                <button class="key" data-key="E">E</button>
                <button class="key" data-key="F">F</button>
                <button class="key" data-key="G">G</button>
                <button class="key" data-key="H">H</button>
            </div>
            <div class="key-row">
                <button class="key" data-key="1">1</button>
                <button class="key" data-key="2">2</button>
                <button class="key" data-key="3">3</button>
                <button class="key" data-key="4">4</button>
                <button class="key" data-key="5">5</button>
                <button class="key" data-key="6">6</button>
                <button class="key" data-key="7">7</button>
                <button class="key" data-key="8">8</button>
            </div>
            <div class="key-row">
                <button class="key" data-key="Backspace">⌫</button>
                <button class="key key-enter" data-key="Enter">SEND</button>
            </div>
        </div>
    </div>

    <div class="instructions">
        <h2>How to Play</h2>
        <ol style="margin: 0; padding-left: 20px;">
            <li><strong>Click "Start Game"</strong> - the board will appear</li>
            <li><strong>Type your move</strong> as 4 characters: from-square + to-square (e.g., <code>E2E4</code>)</li>
            <li><strong>Press SEND</strong> to submit (or use ⌫ to correct)</li>
            <li><strong>Wait</strong> for the computer to respond (~2 seconds)</li>
        </ol>
        <p style="margin-top: 15px;"><strong>Pieces:</strong> K=King, Q=Queen, R=Rook, B=Bishop, N=Knight, P=Pawn</p>
        <p><strong>Colors:</strong> Normal text = White (you) &bull; Inverse/filled = Black (computer)</p>
        <p><strong>Invalid moves</strong> are ignored - try again if nothing happens.</p>
    </div>

    <div class="footer">
        <a href="https://github.com/Cronan/zx81-chess">View source on GitHub</a>
    </div>

    <script src="z80.js"></script>
    <script src="zx81.js"></script>
    <script>
        const CHESS_P = 'AAAAaURqRIJEAACDRH1AAACERIREAF1AAAIAAP///zd9QAAAAAAAjQwAAP//AAC8IRhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAdYD6gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADUzJzc2MAABAwMFCTL3+Pn/AQcICe/x9voGCg8RBAIDBQYDAgTNPUHNdkGvMshAzexBzUxCzXZBzYVCIBY+CDLIQM2bQs1WQs12Qc2FQiAMw/VAIS9BzU5Edhj+ITdBzU5Edhj+PjQ6ADwuM/8uADwuM/8hgkAGQK93IxD8IYJAEedABggadyMTEPoGCD4BdyMQ/CGyQAYIPgl3IxD8EedABgga9gh3IxMQ+MnNKgoqDEAjPgDX1wYIPib11z4A1/E8EPc+dtcOCN0hukA+HIHXPgDXBgjd5dEaxdXN1EHXPgDX0cETEPE+dtfd5eER+P8Z5d3hDSDVPgDX1wYIPib11z4A1/E8EPfJpyADPhvJ9eYHXxYAIclAGX7Ry1vI9oDJPnbXPg/XzR9CMsNAXxYAIYJAGX6nKO/LXyDrPhbXzR9CMsRAXxYAIYJAGX6nyMtfwBjTzTxC1ibmB/XGJtfNPELWHeYH9cYd1/EHBwfRg8l2OiVA/v8o+PU+/zIlQPHJOsNATzrEQEcYCDrFQE86xkBHWRYAIYJAGX42AFgWACGCQBl35gf+AcB4/jgwB/4I0D4Nd8k+BXfJIYJABkAOAH7mB/4GIAEMIxD1ef4Cya8yx0A+/zLFQK/1XxYAIYJAGX6nKB3LXygZ5gdX8fVfev4BytVC/gLKTUP+Bsp5Q8OlQ/E8/kAg0cl71gg49E/NBESnIBs+Ac04RHvmOP4wIA971hBPzQREpyAFPgHNOER71gc4Bk/NEkMoAHvWCTgET80SQxi8e+YHR3nmB5AoMDAC7UT+AjAozQREpygiy18gHuYH5SHQQBYAGeHNBETmB9XlXxYAIdBAGX7h0c04RMkh30AGCMXlfk97gf5AMBVPzRFE/gMwDc0ERMtfIAbNIETNOEThwSMQ3MPOQiHXQAYIxeV+T3uB/kAwFU/NEUT+AjANzQREy18gBs0gRM04ROHBIxDcw85Cev4DPqUoCP4EPlooAj7/IddABghXxeXVeuYBKDd+V3tHgv5AMC5P9XjmB0d55geQMALtRP4CMBvNBESnKA3LXyARzSBEzThE8RgJPgHNOETxGM3x0cs64cEjELnDzkLl1VkWACGCQBl+0eHJ1XvmB1d55geSMALtRNHJzQREpygP5gfl1V8WACHQQBl+0eHJPgHJ1Vc6x0C6MAx6MsdAezLFQHkyxkDRyX7+/8jXIxj4dgACDgD51B0iIR0gfgAAAECCdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnaA';

        let cpu, zx81, running = false, inputBuffer = '', frameInterval = null;

        function init() {
            cpu = new Z80();
            zx81 = new ZX81(cpu, document.getElementById('screen'));
            zx81.initSystemVars();

            // Load chess.p
            const binary = atob(CHESS_P);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            zx81.loadPFile(bytes);

            zx81.render();
            document.getElementById('status').textContent = 'Ready';
        }

        // Core frame execution
        let frameCount = 0;
        let statusMessage = 'Your turn!';
        let thinkingStartFrame = 0;

        function runFrame() {
            if (!running) return false;

            // Process keyboard - one key per frame
            const key = zx81.getKey();
            if (key !== 0xFF) {
                cpu.wb(0x4025, key);
                // On-screen debug for mobile
                const dbg = document.getElementById('debug');
                dbg.textContent = 'SENT:' + key.toString(16) + ' ' + dbg.textContent.substring(0, 100);
            }

            // Run until HALT (or timeout after many instructions)
            let hitHalt = false;
            let instructions = 0;
            for (let i = 0; i < 100000 && running; i++) {
                if (cpu.pc === 0) { running = false; break; }
                const result = cpu.step();
                instructions++;
                if (result === 'halt') { cpu.halted = false; hitHalt = true; break; }
                if (result === 'error') {
                    running = false;
                    statusMessage = 'Error at $' + cpu.pc.toString(16);
                    break;
                }
            }

            frameCount++;

            // Detect if computer is thinking (no HALT = busy computing)
            if (!hitHalt && running) {
                if (thinkingStartFrame === 0) {
                    thinkingStartFrame = frameCount;
                    console.log('Started thinking at frame', frameCount, 'PC=' + cpu.pc.toString(16), 'instr=' + instructions);
                }
                const thinkingFrames = frameCount - thinkingStartFrame;
                if (thinkingFrames > 5) {
                    statusMessage = 'Computer thinking... (' + thinkingFrames + ')';
                }
            } else {
                if (thinkingStartFrame > 0) {
                    // Was thinking, now done
                    console.log('Stopped thinking at frame', frameCount, 'PC=' + cpu.pc.toString(16));
                    statusMessage = 'Your turn!';
                    thinkingStartFrame = 0;
                }
            }

            // Render and update status
            zx81.render();
            const keysWaiting = zx81.keyBuffer.length;
            const pcHex = cpu.pc.toString(16).padStart(4, '0');
            document.getElementById('status').textContent =
                `${statusMessage} | F:${frameCount} K:${keysWaiting} PC:${pcHex} ${hitHalt ? '⏸' : '▶'}`;

            // Debug: show last key written vs read (v2)
            const lw = cpu.lastKeyWritten ? cpu.lastKeyWritten.toString(16) : '-';
            const lr = cpu.lastKeyRead ? cpu.lastKeyRead.toString(16) : '-';
            document.getElementById('debug').textContent = `v2 | LastWrite:${lw} LastRead:${lr}`;

            return running;
        }

        function start() {
            if (running) {
                running = false;
                if (frameInterval) { clearInterval(frameInterval); frameInterval = null; }
                document.getElementById('btn-start').innerHTML = '&#9658; Resume';
                document.getElementById('status').textContent = 'Paused';
                return;
            }

            running = true;
            inputBuffer = '';
            frameCount = 0;
            thinkingStartFrame = 0;
            statusMessage = 'Your turn!';
            document.getElementById('btn-start').innerHTML = '&#10074;&#10074; Pause';
            updateInputDisplay();

            cpu.sp = 0x43FF;
            cpu.pc = 0x40EF;  // Entry point: start label (after data tables)
            cpu.debugLastK = true;  // Enable LAST_K debugging

            runFrame(); // Run first frame immediately
            frameInterval = setInterval(runFrame, 50);
        }

        document.getElementById('btn-start').onclick = start;
        document.getElementById('btn-reset').onclick = () => {
            running = false;
            if (frameInterval) { clearInterval(frameInterval); frameInterval = null; }
            init();
            document.getElementById('btn-start').innerHTML = '&#9658; Start';
        };

        function updateInputDisplay() {
            const display = document.getElementById('input-display');
            if (inputBuffer.length === 0) {
                display.textContent = 'Type move (e.g., E2E4)';
            } else if (inputBuffer.length < 4) {
                display.textContent = inputBuffer + '_'.repeat(4 - inputBuffer.length);
            } else {
                display.textContent = inputBuffer + ' → tap SEND';
            }
        }

        function handleKey(key) {
            if (!running) return false;

            if (key === 'Backspace') {
                if (inputBuffer.length > 0) {
                    inputBuffer = inputBuffer.slice(0, -1);
                    updateInputDisplay();
                }
                return false; // Don't send to emulator
            }

            if (key === 'Enter') {
                if (inputBuffer.length === 4) {
                    // Send all 4 characters to emulator
                    return true; // Signal to send move
                }
                return false; // Not ready
            }

            if (/^[A-Ha-h1-8]$/.test(key) && inputBuffer.length < 4) {
                inputBuffer += key.toUpperCase();
                updateInputDisplay();
            }
            return false;
        }

        document.addEventListener('keydown', (e) => {
            if (handleKey(e.key)) {
                sendMoveToEmulator();
            }
            if (e.key === 'Backspace') e.preventDefault();
        });

        function sendMoveToEmulator() {
            if (inputBuffer.length !== 4) return;

            // Push all 4 characters to key buffer - setInterval will process them
            console.log('Sending move:', inputBuffer);
            for (const char of inputBuffer) {
                const code = zx81.keyMap[char];
                console.log('  Key', char, '→ code', code ? code.toString(16) : 'undefined');
                if (code !== undefined) {
                    zx81.keyBuffer.push(code);
                }
            }

            inputBuffer = '';
            updateInputDisplay();
            // setInterval will handle processing and auto-detect thinking state
        }

        // Touch keyboard
        const touchKeyboard = document.getElementById('touch-keyboard');

        function handleTouchKey(key) {
            if (!key || !running) return;
            if (handleKey(key)) {
                sendMoveToEmulator();
            }
        }

        touchKeyboard.addEventListener('touchend', (e) => {
            e.preventDefault();
            const key = e.target.dataset.key;
            handleTouchKey(key);
        });

        touchKeyboard.addEventListener('click', (e) => {
            const key = e.target.dataset.key;
            handleTouchKey(key);
        });

        init();
    </script>
</body>
</html>
