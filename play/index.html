<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZX81 1K Chess - Play Online</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background: #1a1a2e;
            color: #eee;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { color: #fff; margin-bottom: 5px; font-size: 24px; }
        .subtitle { color: #888; margin-bottom: 20px; font-size: 14px; }
        .zx81-case {
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .screen-bezel {
            background: #111;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        #screen {
            display: block;
            background: #fff;
            image-rendering: pixelated;
            max-width: 100%;
            height: auto;
        }
        .sinclair-logo {
            color: #c00;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            margin-bottom: 15px;
            letter-spacing: 3px;
        }
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        button {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover { background: #444; }
        #move-input {
            margin-top: 10px;
            text-align: center;
        }
        .move-slots {
            display: inline-flex;
            gap: 4px;
            align-items: center;
            font-size: 28px;
            letter-spacing: 2px;
        }
        .move-slot {
            width: 36px;
            height: 44px;
            line-height: 44px;
            text-align: center;
            border-radius: 4px;
            background: rgba(0,0,0,0.4);
            color: #4fc3f7;
            border: 2px solid transparent;
        }
        .move-slot.active {
            border-color: #4fc3f7;
            background: rgba(79,195,247,0.15);
        }
        .move-slot.filled {
            color: #fff;
        }
        .move-arrow {
            color: #666;
            font-size: 18px;
            margin: 0 2px;
        }
        .move-hint {
            color: #888;
            font-size: 12px;
            margin-top: 6px;
        }
        .status { color: #4fc3f7; font-size: 12px; margin-top: 10px; text-align: center; }
        .instructions {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-width: 768px;
            line-height: 1.6;
        }
        .instructions h2 { color: #fff; margin-top: 0; font-size: 16px; }
        code { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; color: #4fc3f7; }
        .footer { margin-top: 30px; color: #666; font-size: 12px; }
        .footer a { color: #888; }
        .touch-keyboard {
            display: none;
            margin-top: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
        }
        .key-row {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 5px;
        }
        .key {
            background: #444;
            color: #fff;
            border: 1px solid #666;
            padding: 12px 16px;
            font-family: inherit;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            min-width: 44px;
            text-align: center;
        }
        .key:active { background: #666; }
        .key.hidden { visibility: hidden; }
        @media (pointer: coarse) {
            .touch-keyboard { display: block; }
        }
        @media (max-width: 600px) {
            body { padding: 10px; }
            .zx81-case { padding: 15px; max-width: 100%; }
            .screen-bezel { padding: 8px; overflow: hidden; }
            h1 { font-size: 20px; }
            .instructions { padding: 15px; font-size: 14px; }
            .key { padding: 10px 12px; min-width: 36px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <h1>ZX81 1K Chess</h1>
    <p class="subtitle">672 bytes of Z80 machine code &bull; 1K RAM</p>

    <div class="zx81-case">
        <div class="sinclair-logo">SINCLAIR ZX81</div>
        <div class="screen-bezel">
            <canvas id="screen"></canvas>
        </div>
        <div id="move-input">
            <div class="move-slots">
                <span class="move-slot" id="s0">_</span>
                <span class="move-slot" id="s1">_</span>
                <span class="move-arrow">&rarr;</span>
                <span class="move-slot" id="s2">_</span>
                <span class="move-slot" id="s3">_</span>
            </div>
            <div class="move-hint" id="move-hint">Type file A-H</div>
        </div>
        <div class="controls">
            <button id="btn-start">&#9658; Start Game</button>
            <button id="btn-reset">&#8635; Reset</button>
        </div>
        <div class="status" id="status">Click Start Game to play! You are White.</div>
        <div class="touch-keyboard" id="touch-keyboard"></div>
    </div>

    <div class="instructions">
        <h2>How to Play</h2>
        <ol style="margin: 0; padding-left: 20px;">
            <li><strong>Click "Start Game"</strong> - the board will appear</li>
            <li><strong>Type your move</strong> - from-square then to-square (e.g., <code>E2E4</code>)</li>
            <li><strong>Auto-submits</strong> after 4 characters. Backspace to correct.</li>
        </ol>
        <p style="margin-top: 15px;"><strong>Pieces:</strong> K=King, Q=Queen, R=Rook, B=Bishop, N=Knight, P=Pawn</p>
        <p><strong>Colors:</strong> Normal text = White (you) &bull; Inverse/filled = Black (computer)</p>
        <p><strong>Invalid moves</strong> are rejected - the board re-prompts for input.</p>
    </div>

    <div class="footer">
        <a href="https://github.com/Cronan/zx81-chess">View source on GitHub</a>
    </div>

    <script src="z80.js"></script>
    <script src="zx81.js"></script>
    <script>
        const CHESS_P = 'AAAAaURqRIJEAACDRH1AAACERIREAF1AAAIAAP///zd9QAAAAAAAjQwAAP//AAC8IRhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAdYD6gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADUzJzc2MAABAwMFCTL3+Pn/AQcICe/x9voGCg8RBAIDBQYDAgTNPUHNdkGvMshAzexBzUxCzXZBzYVCIBY+CDLIQM2bQs1WQs12Qc2FQiAMw/VAIS9BzU5Edhj+ITdBzU5Edhj+PjQ6ADwuM/8uADwuM/8hgkAGQK93IxD8IYJAEedABggadyMTEPoGCD4BdyMQ/CGyQAYIPgl3IxD8EedABgga9gh3IxMQ+MnNKgoqDEAjPgDX1wYIPib11z4A1/E8EPc+dtcOCN0hukA+HIHXPgDXBgjd5dEaxdXN1EHXPgDX0cETEPE+dtfd5eER+P8Z5d3hDSDVPgDX1wYIPib11z4A1/E8EPfJpyADPhvJ9eYHXxYAIclAGX7Ry1rI9oDJPnbXPg/XzR9CMsNAXxYAIYJAGX6nKO/LXyDrPhbXzR9CMsRAXxYAIYJAGX6nyMtfwBjTzTxC1ibmB/XGJtfNPELWHeYH9cYd1/EHBwfRgsl2OiVA/v8o+PU+/zIlQPHJOsNATzrEQEcYCDrFQE86xkBHWRYAIYJAGX42AFgWACGCQBl35gf+AcB4/jgwB/4I0D4Nd8k+BXfJIYJABkAOAH7mB/4GIAEMIxD1ef4Cya8yx0A+/zLFQK/1XxYAIYJAGX6nKB3LXygZ5gdX8fVfev4BytVC/gLKTUP+Bsp5Q8OlQ/E8/kAg0cl71gg49E/NBESnIBs+Ac04RHvmOP4wIA971hBPzQREpyAFPgHNOER71gc4Bk/NEkMoAHvWCTgET80SQxi8e+YHR3nmB5AoMDAC7UT+AjAozQREpygiy18gHuYH5SHQQBYAGeHNBETmB9XlXxYAIdBAGX7h0c04RMkh30AGCMXlfk97gf5AMBVPzRFE/gMwDc0ERMtfIAbNIETNOEThwSMQ3MPOQiHXQAYIxeV+T3uB/kAwFU/NEUT+AjANzQREy18gBs0gRM04ROHBIxDcw85Cev4FPv8wCD5ay0IoAj6lIddABghXxeXVeuYBKDd+V3tHgv5AMC5P9XjmB0d55geQMALtRP4CMBvNBESnKA3LXyARzSBEzThE8RgJPgHNOETxGM3x0cs64cEjELnDzkLl1VkWACGCQBl+0eHJ1XvmB1d55geSMALtRNHJzQREpygP5gfl1V8WACHQQBl+0eHJPgHJ1Vc6x0C6MAx6MsdAezLFQHkyxkDRyX7+/8jXIxj4dgACDgD51B0iIR0gfgAAAECCdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnaA';

        let cpu, zx81, running = false, frameInterval = null;
        // Input state: exactly 4 positions, alternating file/rank
        // Position 0: file (A-H), 1: rank (1-8), 2: file (A-H), 3: rank (1-8)
        let moveChars = [];
        let waitingForInput = true;

        const HINTS = ['Type file A-H', 'Type rank 1-8', 'Type file A-H', 'Type rank 1-8'];
        const FILES = 'ABCDEFGH';
        const RANKS = '12345678';

        function isFilePosition(pos) { return pos === 0 || pos === 2; }

        function validKeyForPosition(key, pos) {
            const k = key.toUpperCase();
            if (isFilePosition(pos)) return FILES.includes(k) ? k : null;
            return RANKS.includes(k) ? k : null;
        }

        function updateMoveDisplay() {
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById('s' + i);
                if (i < moveChars.length) {
                    el.textContent = moveChars[i];
                    el.className = 'move-slot filled';
                } else if (i === moveChars.length && waitingForInput) {
                    el.textContent = '_';
                    el.className = 'move-slot active';
                } else {
                    el.textContent = '_';
                    el.className = 'move-slot';
                }
            }
            const hint = document.getElementById('move-hint');
            if (!running) {
                hint.textContent = '';
            } else if (!waitingForInput) {
                hint.textContent = 'Computer thinking...';
            } else if (moveChars.length < 4) {
                hint.textContent = HINTS[moveChars.length];
            } else {
                hint.textContent = '';
            }
            updateTouchKeyboard();
        }

        function updateTouchKeyboard() {
            const container = document.getElementById('touch-keyboard');
            if (!running || !waitingForInput) {
                container.innerHTML = '';
                return;
            }
            const pos = moveChars.length;
            if (pos >= 4) { container.innerHTML = ''; return; }

            const keys = isFilePosition(pos) ? FILES.split('') : RANKS.split('');
            let html = '<div class="key-row">';
            for (const k of keys) {
                html += `<button class="key" data-key="${k}">${k}</button>`;
            }
            html += '</div>';
            if (moveChars.length > 0) {
                html += '<div class="key-row"><button class="key" data-key="Backspace">&#9003; Undo</button></div>';
            }
            container.innerHTML = html;
        }

        function init() {
            cpu = new Z80();
            zx81 = new ZX81(cpu, document.getElementById('screen'));
            zx81.initSystemVars();

            const binary = atob(CHESS_P);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            zx81.loadPFile(bytes);

            zx81.render();
            moveChars = [];
            waitingForInput = true;
            document.getElementById('status').textContent = 'Click Start Game to play! You are White.';
            updateMoveDisplay();
        }

        // Core frame execution
        let frameCount = 0;
        let thinkingStartFrame = 0;

        function runFrame() {
            if (!running) return false;

            let hitHalt = false;
            for (let i = 0; i < 100000 && running; i++) {
                if (cpu.pc === 0) { running = false; break; }
                const result = cpu.step();

                if (result === 'halt') {
                    const key = zx81.getKey();
                    if (key !== 0xFF) {
                        cpu.ww(0x4025, key);
                    } else {
                        cpu.ww(0x4025, 0xFFFF);
                    }
                    cpu.halted = false;
                    hitHalt = true;
                    break;
                }
                if (result === 'error') {
                    running = false;
                    document.getElementById('status').textContent = 'Error at $' + cpu.pc.toString(16);
                    break;
                }
            }

            frameCount++;

            // Detect thinking vs waiting for input
            if (!hitHalt && running) {
                if (thinkingStartFrame === 0) thinkingStartFrame = frameCount;
                waitingForInput = false;
            } else {
                if (thinkingStartFrame > 0) {
                    // Computer finished thinking
                    thinkingStartFrame = 0;
                    waitingForInput = true;
                    moveChars = [];
                }
            }

            zx81.render();

            // Status line
            if (!waitingForInput) {
                document.getElementById('status').textContent = 'Computer is thinking...';
            } else if (zx81.keyBuffer.length > 0) {
                document.getElementById('status').textContent = 'Processing move...';
            } else {
                document.getElementById('status').textContent = 'Your turn!';
            }

            updateMoveDisplay();
            return running;
        }

        function start() {
            if (running) {
                running = false;
                if (frameInterval) { clearInterval(frameInterval); frameInterval = null; }
                document.getElementById('btn-start').innerHTML = '&#9658; Resume';
                document.getElementById('status').textContent = 'Paused';
                return;
            }

            running = true;
            moveChars = [];
            frameCount = 0;
            thinkingStartFrame = 0;
            waitingForInput = true;
            document.getElementById('btn-start').innerHTML = '&#10074;&#10074; Pause';

            cpu.sp = 0x7FFF;  // Stack must be above code (code ends at 0x4455)
            cpu.pc = 0x40EF;  // Entry point: start label (after data tables)
            cpu.ww(0x4025, 0xFFFF);  // LAST_K = no key

            updateMoveDisplay();
            runFrame();
            frameInterval = setInterval(runFrame, 50);
        }

        function sendMove() {
            if (moveChars.length !== 4) return;
            for (const ch of moveChars) {
                const code = zx81.keyMap[ch];
                if (code !== undefined) zx81.keyBuffer.push(code);
            }
        }

        function handleKey(key) {
            if (!running || !waitingForInput) return;
            if (key === 'Backspace' || key === 'Delete') {
                if (moveChars.length > 0) {
                    moveChars.pop();
                    updateMoveDisplay();
                }
                return;
            }

            const pos = moveChars.length;
            if (pos >= 4) return;

            const valid = validKeyForPosition(key, pos);
            if (!valid) return;

            moveChars.push(valid);
            updateMoveDisplay();

            // Auto-submit when all 4 characters entered
            if (moveChars.length === 4) {
                sendMove();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (/^[a-hA-H1-8]$/.test(e.key) || e.key === 'Backspace' || e.key === 'Delete') {
                e.preventDefault();
                handleKey(e.key);
            }
        });

        document.getElementById('btn-start').onclick = start;
        document.getElementById('btn-reset').onclick = () => {
            running = false;
            if (frameInterval) { clearInterval(frameInterval); frameInterval = null; }
            init();
            document.getElementById('btn-start').innerHTML = '&#9658; Start Game';
        };

        // Touch keyboard - delegated event handling
        document.getElementById('touch-keyboard').addEventListener('touchend', (e) => {
            e.preventDefault();
            const key = e.target.dataset.key;
            if (key) handleKey(key);
        });
        document.getElementById('touch-keyboard').addEventListener('click', (e) => {
            const key = e.target.dataset.key;
            if (key) handleKey(key);
        });

        init();
    </script>
</body>
</html>
