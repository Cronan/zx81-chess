<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ZX81 1K Chess</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            background: #111;
            color: #eee;
            font-family: 'Courier New', monospace;
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }
        .zx81-case {
            background: linear-gradient(180deg, #222 0%, #181818 100%);
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
        }
        .sinclair-logo {
            color: #c00;
            font-weight: bold;
            font-size: 13px;
            text-align: right;
            letter-spacing: 2px;
            margin-bottom: 6px;
            padding-right: 4px;
        }
        .screen-bezel {
            background: #000;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
        }
        #screen {
            display: block;
            width: 100%;
            height: auto;
            background: #fff;
            image-rendering: pixelated;
        }
        /* Move input display */
        .move-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin-bottom: 6px;
            height: 36px;
        }
        .move-slot {
            width: 28px;
            height: 32px;
            line-height: 32px;
            text-align: center;
            border-radius: 3px;
            background: rgba(255,255,255,0.06);
            color: #666;
            font-size: 20px;
            font-weight: bold;
        }
        .move-slot.active {
            border: 1.5px solid #4fc3f7;
            background: rgba(79,195,247,0.1);
            color: #4fc3f7;
        }
        .move-slot.filled { color: #fff; }
        .move-arrow { color: #555; font-size: 14px; margin: 0 2px; }
        .status {
            color: #888;
            font-size: 11px;
            text-align: center;
            margin-bottom: 8px;
            height: 14px;
        }
        /* ZX81-style keyboard */
        .zx81-keyboard {
            background: #1a1a1a;
            border-radius: 0 0 8px 8px;
            padding: 8px 4px 10px;
        }
        .kb-row {
            display: flex;
            justify-content: center;
            gap: 3px;
            margin-bottom: 3px;
        }
        .kb-key {
            flex: 1;
            max-width: 42px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2a2a2a;
            color: #555;
            border: 1px solid #333;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            transition: background 0.15s, color 0.15s, border-color 0.15s;
        }
        .kb-key.valid {
            background: #3a3a3a;
            color: #fff;
            border-color: #4fc3f7;
            box-shadow: 0 0 6px rgba(79,195,247,0.25);
        }
        .kb-key.valid:active {
            background: #4fc3f7;
            color: #000;
        }
        .kb-key.fn {
            max-width: 64px;
            font-size: 10px;
            letter-spacing: 0.5px;
        }
        .kb-key.flash {
            background: #fff !important;
            color: #000 !important;
            border-color: #fff !important;
            transition: none;
        }
        /* Reset button */
        .reset-bar {
            display: flex;
            justify-content: center;
            margin-top: 6px;
        }
        .reset-btn {
            background: none;
            border: 1px solid #333;
            color: #666;
            font-family: inherit;
            font-size: 10px;
            padding: 4px 14px;
            border-radius: 3px;
            cursor: pointer;
        }
        .reset-btn:hover { border-color: #666; color: #aaa; }
        /* Footer */
        .footer {
            margin-top: 8px;
            text-align: center;
        }
        .footer a {
            color: #444;
            font-size: 10px;
            text-decoration: none;
        }
        @media (max-width: 360px) {
            .zx81-case { padding: 8px; }
            .kb-key { height: 32px; font-size: 12px; }
            .kb-key.fn { font-size: 9px; }
        }
        @media (min-height: 700px) {
            .kb-key { height: 40px; }
        }
    </style>
</head>
<body>
    <div class="zx81-case">
        <div class="sinclair-logo">SINCLAIR ZX81</div>
        <div class="screen-bezel">
            <canvas id="screen"></canvas>
        </div>
        <div class="move-bar" id="move-bar">
            <span class="move-slot active" id="s0">_</span>
            <span class="move-slot" id="s1">_</span>
            <span class="move-arrow">&rarr;</span>
            <span class="move-slot" id="s2">_</span>
            <span class="move-slot" id="s3">_</span>
        </div>
        <div class="status" id="status">Your turn</div>
        <div class="zx81-keyboard" id="keyboard">
            <div class="kb-row" id="row1">
                <div class="kb-key" data-key="1">1</div>
                <div class="kb-key" data-key="2">2</div>
                <div class="kb-key" data-key="3">3</div>
                <div class="kb-key" data-key="4">4</div>
                <div class="kb-key" data-key="5">5</div>
                <div class="kb-key" data-key="6">6</div>
                <div class="kb-key" data-key="7">7</div>
                <div class="kb-key" data-key="8">8</div>
                <div class="kb-key" data-key="9">9</div>
                <div class="kb-key" data-key="0">0</div>
            </div>
            <div class="kb-row" id="row2">
                <div class="kb-key" data-key="Q">Q</div>
                <div class="kb-key" data-key="W">W</div>
                <div class="kb-key" data-key="E">E</div>
                <div class="kb-key" data-key="R">R</div>
                <div class="kb-key" data-key="T">T</div>
                <div class="kb-key" data-key="Y">Y</div>
                <div class="kb-key" data-key="U">U</div>
                <div class="kb-key" data-key="I">I</div>
                <div class="kb-key" data-key="O">O</div>
                <div class="kb-key" data-key="P">P</div>
            </div>
            <div class="kb-row" id="row3">
                <div class="kb-key" data-key="A">A</div>
                <div class="kb-key" data-key="S">S</div>
                <div class="kb-key" data-key="D">D</div>
                <div class="kb-key" data-key="F">F</div>
                <div class="kb-key" data-key="G">G</div>
                <div class="kb-key" data-key="H">H</div>
                <div class="kb-key" data-key="J">J</div>
                <div class="kb-key" data-key="K">K</div>
                <div class="kb-key" data-key="L">L</div>
                <div class="kb-key fn" data-key="NEWLINE">ENTER</div>
            </div>
            <div class="kb-row" id="row4">
                <div class="kb-key fn" data-key="DEL">DEL</div>
                <div class="kb-key" data-key="Z">Z</div>
                <div class="kb-key" data-key="X">X</div>
                <div class="kb-key" data-key="C">C</div>
                <div class="kb-key" data-key="V">V</div>
                <div class="kb-key" data-key="B">B</div>
                <div class="kb-key" data-key="N">N</div>
                <div class="kb-key" data-key="M">M</div>
                <div class="kb-key" data-key=".">.</div>
                <div class="kb-key fn" data-key="SPACE">SPACE</div>
            </div>
        </div>
        <div class="reset-bar">
            <button class="reset-btn" id="btn-reset">RESET</button>
        </div>
    </div>
    <div class="footer">
        <a href="https://github.com/Cronan/zx81-chess">ZX81 1K Chess &middot; 672 bytes of Z80</a>
    </div>

    <script src="z80.js"></script>
    <script src="zx81.js"></script>
    <script>
        const CHESS_P = 'AAAAaURqRIJEAACDRH1AAACERIREAF1AAAIAAP///zd9QAAAAAAAjQwAAP//AAC8IRhAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAdYD6gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADUzJzc2MAABAwMFCTL3+Pn/AQcICe/x9voGCg8RBAIDBQYDAgTNPUHNdkGvMshAzexBzUxCzXZBzYVCIBY+CDLIQM2bQs1WQs12Qc2FQiAMw/VAIS9BzU5Edhj+ITdBzU5Edhj+PjQ6ADwuM/8uADwuM/8hgkAGQK93IxD8IYJAEedABggadyMTEPoGCD4BdyMQ/CGyQAYIPgl3IxD8EedABgga9gh3IxMQ+MnNKgoqDEAjPgDX1wYIPib11z4A1/E8EPc+dtcOCN0hukA+HIHXPgDXBgjd5dEaxdXN1EHXPgDX0cETEPE+dtfd5eER+P8Z5d3hDSDVPgDX1wYIPib11z4A1/E8EPfJpyADPhvJ9eYHXxYAIclAGX7Ry1rI9oDJPnbXPg/XzR9CMsNAXxYAIYJAGX6nKO/LXyDrPhbXzR9CMsRAXxYAIYJAGX6nyMtfwBjTzTxC1ibmB/XGJtfNPELWHeYH9cYd1/EHBwfRgsl2OiVA/v8o+PU+/zIlQPHJOsNATzrEQEcYCDrFQE86xkBHWRYAIYJAGX42AFgWACGCQBl35gf+AcB4/jgwB/4I0D4Nd8k+BXfJIYJABkAOAH7mB/4GIAEMIxD1ef4Cya8yx0A+/zLFQK/1XxYAIYJAGX6nKB3LXygZ5gdX8fVfev4BytVC/gLKTUP+Bsp5Q8OlQ/E8/kAg0cl71gg49E/NBESnIBs+Ac04RHvmOP4wIA971hBPzQREpyAFPgHNOER71gc4Bk/NEkMoAHvWCTgET80SQxi8e+YHR3nmB5AoMDAC7UT+AjAozQREpygiy18gHuYH5SHQQBYAGeHNBETmB9XlXxYAIdBAGX7h0c04RMkh30AGCMXlfk97gf5AMBVPzRFE/gMwDc0ERMtfIAbNIETNOEThwSMQ3MPOQiHXQAYIxeV+T3uB/kAwFU/NEUT+AjANzQREy18gBs0gRM04ROHBIxDcw85Cev4FPv8wCD5ay0IoAj6lIddABghXxeXVeuYBKDd+V3tHgv5AMC5P9XjmB0d55geQMALtRP4CMBvNBESnKA3LXyARzSBEzThE8RgJPgHNOETxGM3x0cs64cEjELnDzkLl1VkWACGCQBl+0eHJ1XvmB1d55geSMALtRNHJzQREpygP5gfl1V8WACHQQBl+0eHJPgHJ1Vc6x0C6MAx6MsdAezLFQHkyxkDRyX7+/8jXIxj4dgACDgD51B0iIR0gfgAAAECCdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnaA';

        let cpu, zx81, running = false, frameInterval = null;
        let moveChars = [];
        let waitingForInput = true;

        const FILES = 'ABCDEFGH';
        const RANKS = '12345678';

        function isFilePosition(pos) { return pos === 0 || pos === 2; }

        function validKeyForPosition(key, pos) {
            const k = key.toUpperCase();
            if (isFilePosition(pos)) return FILES.includes(k) ? k : null;
            return RANKS.includes(k) ? k : null;
        }

        // --- Keyboard highlight management ---
        function updateKeyboard() {
            const keys = document.querySelectorAll('.kb-key');
            const pos = moveChars.length;

            keys.forEach(el => {
                const k = el.dataset.key;
                let isValid = false;

                if (running && waitingForInput && pos < 4) {
                    if (k === 'DEL' && pos > 0) {
                        isValid = true;
                    } else if (isFilePosition(pos) && FILES.includes(k)) {
                        isValid = true;
                    } else if (!isFilePosition(pos) && RANKS.includes(k)) {
                        isValid = true;
                    }
                }

                el.classList.toggle('valid', isValid);
            });
        }

        function updateMoveDisplay() {
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById('s' + i);
                if (i < moveChars.length) {
                    el.textContent = moveChars[i];
                    el.className = 'move-slot filled';
                } else if (i === moveChars.length && waitingForInput && running) {
                    el.textContent = '_';
                    el.className = 'move-slot active';
                } else {
                    el.textContent = '_';
                    el.className = 'move-slot';
                }
            }

            const status = document.getElementById('status');
            if (!running) {
                status.textContent = '';
            } else if (!waitingForInput) {
                status.textContent = 'Computer thinking\u2026';
            } else {
                const hints = ['File A\u2013H', 'Rank 1\u20138', 'File A\u2013H', 'Rank 1\u20138'];
                status.textContent = moveChars.length < 4 ? hints[moveChars.length] : 'Your turn';
            }

            updateKeyboard();
        }

        // --- Flash + haptic feedback ---
        function flashKey(el) {
            el.classList.add('flash');
            setTimeout(() => el.classList.remove('flash'), 80);
            if (navigator.vibrate) navigator.vibrate(15);
        }

        // --- Input handling ---
        function handleKey(key) {
            if (!running || !waitingForInput) return;

            if (key === 'DEL' || key === 'Backspace' || key === 'Delete') {
                if (moveChars.length > 0) {
                    moveChars.pop();
                    updateMoveDisplay();
                }
                return;
            }

            const pos = moveChars.length;
            if (pos >= 4) return;

            const valid = validKeyForPosition(key, pos);
            if (!valid) return;

            moveChars.push(valid);
            updateMoveDisplay();

            if (moveChars.length === 4) {
                sendMove();
            }
        }

        function sendMove() {
            if (moveChars.length !== 4) return;
            for (const ch of moveChars) {
                const code = zx81.keyMap[ch];
                if (code !== undefined) zx81.keyBuffer.push(code);
            }
            // Clear immediately so keyboard re-enables after computer responds,
            // even if think completes within a single frame
            moveChars = [];
            updateMoveDisplay();
        }

        // --- Emulator ---
        function runFrame() {
            if (!running) return;

            const wasWaiting = waitingForInput;
            let hitHalt = false;
            for (let i = 0; i < 100000 && running; i++) {
                if (cpu.pc === 0) { running = false; break; }
                const result = cpu.step();
                if (result === 'halt') {
                    const key = zx81.getKey();
                    cpu.ww(0x4025, key !== 0xFF ? key : 0xFFFF);
                    cpu.halted = false;
                    hitHalt = true;
                    break;
                }
                if (result === 'error') {
                    running = false;
                    document.getElementById('status').textContent = 'Error at $' + cpu.pc.toString(16);
                    break;
                }
            }

            // State detection: HALT = waiting for key, no HALT = computing
            if (!hitHalt && running) {
                waitingForInput = false;
            } else if (hitHalt) {
                waitingForInput = true;
            }

            // Clear move input on transition from computing back to waiting
            if (waitingForInput && !wasWaiting) {
                moveChars = [];
            }

            zx81.render();
            updateMoveDisplay();
        }

        function init() {
            cpu = new Z80();
            zx81 = new ZX81(cpu, document.getElementById('screen'));
            zx81.initSystemVars();

            const binary = atob(CHESS_P);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            zx81.loadPFile(bytes);

            zx81.render();
        }

        function start() {
            running = true;
            moveChars = [];
            waitingForInput = true;

            cpu.sp = 0x7FFF;
            cpu.pc = 0x40EF;
            cpu.ww(0x4025, 0xFFFF);

            updateMoveDisplay();
            runFrame();
            frameInterval = setInterval(runFrame, 50);
        }

        // --- Event listeners ---

        // Physical keyboard
        document.addEventListener('keydown', (e) => {
            if (/^[a-hA-H1-8]$/.test(e.key) || e.key === 'Backspace' || e.key === 'Delete') {
                e.preventDefault();
                handleKey(e.key);
            }
        });

        // Touch keyboard - use pointer events for immediate response
        document.getElementById('keyboard').addEventListener('pointerdown', (e) => {
            const el = e.target.closest('.kb-key');
            if (!el || !el.classList.contains('valid')) return;
            e.preventDefault();
            flashKey(el);
            handleKey(el.dataset.key);
        });

        // Prevent context menu on long-press
        document.getElementById('keyboard').addEventListener('contextmenu', (e) => e.preventDefault());

        // Reset
        document.getElementById('btn-reset').onclick = () => {
            running = false;
            if (frameInterval) { clearInterval(frameInterval); frameInterval = null; }
            init();
            start();
        };

        // Auto-start on load
        init();
        start();
    </script>
</body>
</html>
